<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inicio - Cinex Unidos</title>
    <meta
      name="description"
      content="Bienvenido a Cinex Unidos. Disfruta de las últimas películas en tu cine local."
    />
    <link
      rel="shortcut icon"
      href="/images/cinex-unidos-p.ico"
      type="image/x-icon"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* GENERALES */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", Arial, Helvetica, sans-serif;
        background-color: #1e1e1e;
      }

      select {
        font-family: "Inter", Arial, Helvetica, sans-serif;
      }
      /* INICIO HEADER */
      .titleLogo {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 1rem;
      }

      .titleLogoImg {
        width: 200px;
      }
      .menu-principal {
        background-color: #1e1e1e;
        display: flex;
        justify-content: center;
        margin-top: 0.5rem;
      }
      .menu-principal ul {
        display: flex;
        justify-content: space-between;
        list-style: none;
        width: 100%;
      }
      .item-menu {
        padding: 0.5rem;
        background-color: #d5d6d9;
        width: 128px;
        text-align: center;
        cursor: pointer;
      }
      .item-menu a {
        text-decoration: none;
        color: #1e1e1e;
        font-weight: bold;
      }

      .item-menu--actual,
      .item-menu:hover {
        background-color: #ce2632;
      }
      .item-menu--actual a,
      .item-menu:hover a {
        color: #d5d6d9;
      }
      /* FIN HEADER */
      /* INICIO MAIN */
      main {
        margin: 1.5rem 1rem;
        background-color: #e6e6e7;
        border-radius: 16px;
        padding: 1rem;
        min-height: 100%;
      }
      .container-titulo-cartelera {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .titulo-cartelera {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333333;
      }
      #seleccionarCine {
        padding: 0.5rem;
        border-radius: 8px;
        border: 2px solid #333333;
        font-weight: bold;
      }
      hr {
        border: 1px solid #bfbfbf;
      }

      /* ESTILOS PELICULAS */
      .peliculas {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        align-items: baseline;
        margin-top: 1rem;
      }
      .pelicula {
        border-radius: 8px;
        margin: 1rem;
        display: flex;
        justify-content: center;
        flex-direction: column;
      }
      .pelicula img {
        width: 100%;
        box-shadow: 0px 4px 20px 0px rgba(0, 0, 0, 0.67);
      }
      .descripcion-pelicula {
        margin-top: 1rem;
      }
      .descripcion-pelicula h1 {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333333;
        text-align: center;
      }
      .descripcion-pelicula p {
        margin-top: 0.25rem;
        font-size: 0.7rem;
        font-weight: 500;
        color: #888;
        text-align: center;
        line-height: normal;
      }

      .boton-comprar-pelicula {
        display: block;
        background-color: #ce2632;
        color: #e6e6e7;
        padding: 0.5rem;
        text-align: center;
        border-radius: 8px;
        margin-top: 0.5rem;
        text-decoration: none;
        font-weight: bold;
      }
      /* FIN MAIN */
      /* INICIO FOOTER */
      footer {
        color: #f8f8f8;
        display: grid;
        /* quiero que tenga 3 columnas siempre, excepto en mobile */
        grid-template-columns: repeat(3, 1fr);
        justify-content: space-around;
        padding: 1rem;
        margin: 1rem 0;
      }

      footer div {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      footer div img {
        width: 24px;
        margin-right: 0.5rem;
      }

      footer div strong {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      footer div nav {
        display: flex;
        justify-content: center;
        gap: 1rem;
      }

      footer div address {
        font-style: normal;
      }

      footer div address ul li {
        list-style: none;
        padding: 0.125rem 0;
      }
      /* FIN FOOTER */

      /* VISTAS */
      /* INICIO VISTA COMPRAR ENTRADAS */
      .vista-comprar-entrada {
        display: none;
      }
      .info-pelicula-comprar {
        display: grid;
        grid-template-columns: 1fr 3fr;
        gap: 6rem;
        padding: 4rem 8rem;
      }
      .info-pelicula-comprar .detalles {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }
      #nombre-pelicula {
        font-size: 3rem;
        font-weight: bold;
        color: #333333;
      }
      #rating-duracion-pelicula {
        font-size: 1.25rem;
        font-weight: 500;
        color: #888;
      }
      #descripcion-pelicula-comprar {
        font-size: 1rem;
        font-weight: 500;
        color: #333333;
      }
      #poster-pelicula {
        width: 100%;
        box-shadow: 0px 4px 20px 0px rgba(0, 0, 0, 0.67);
      }
      #cineSeleccionado {
        display: inline-block;
        font-size: 1.25rem;
        font-weight: bold;
        color: #fff;
        background-color: #ce2632;
        padding: 0.625rem 1rem;
        border-radius: 8px;
      }

      #container-seleccionar-sala {
        display: flex;
        margin: 0 8rem;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .movie-hour-option {
        display: inline-block;
        font-size: 1.25rem;
        font-weight: bold;
        color: #333;
        border: 1px solid #333;
        padding: 0.625rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        text-align: center;
      }

      .movie-hour-option:hover {
        background-color: #333;
        color: #fff;
      }

      .movie-hour-option--selected {
        background-color: #333;
        color: #fff;
      }

      .container-ver-asientos {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        background-color: #333333;
        margin: 0 8rem 4rem 8rem;
        padding: 1rem 2rem;
        border-radius: 8px;
      }

      .container-leyenda-asientos {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
      }

      .leyenda-estatus-asiento {
        width: 100%;
        display: inline-block;
        font-size: 1rem;
        font-weight: bold;
        color: #333333;
        margin-right: 1rem;
        text-align: center;
      }

      .fila-counter {
        text-align: center;
      }

      .ocupado {
        background-color: #ce2632;
        color: #ffffff;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
      }

      .disponible {
        background-color: #5bb257;
        color: #333333;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
      }

      .seleccionado {
        cursor: pointer;
        background-color: #161b62;
        color: #e6e6e7;
        padding: 0.5rem;
        border-radius: 6px;
      }

      .seleccionado-otro {
        background-color: #2831ad;
        color: #e6e6e7;
        padding: 0.5rem;
        border-radius: 6px;
      }

      .container-asientos {
        overflow: hidden;
        display: grid;
        align-self: center;
        gap: 0.125rem;
      }

      .container-asientos div {
        color: white;
      }
      /* FIN VISTA COMPRAR ENTRADAS */

      .resumen-compra {
        margin: 0 8rem;
      }

      #boton-reservar {
        display: block;
        background-color: #ce2632;
        color: #e6e6e7;
        padding: 0.5rem;
        text-align: center;
        border-radius: 8px;
        margin-top: 1rem;
        font-weight: bold;
        cursor: pointer;
        border: none;
      }

      .chat-button {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background-color: #ce2632;
        color: #e6e6e7;
        padding: 0.7rem;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0px 4px 20px 0px rgba(0, 0, 0, 0.67);
      }

      .chat-button:hover {
        background-color: #8b1d25;
      }

      .chat {
        position: fixed;
        bottom: 0;
        right: 2rem;
        background-color: #e6e6e7;
        border-radius: 8px 8px 0 0;
        display: none;
        width: 300px;
        height: 400px;
        box-shadow: 0px 4px 20px 0px rgba(0, 0, 0, 0.67);
      }

      .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #333;
      }

      .chat-header h1 {
        font-size: 1.25rem;
        font-weight: bold;
        color: #333;
      }

      .chat-header button {
        background-color: #ce2632;
        color: #e6e6e7;
        padding: 0.5rem;
        border-radius: 8px;
        cursor: pointer;
        border: none;
      }

      .chat-body {
        padding: 1rem;
        overflow-y: scroll;
        height: 300px;
      }

      .chat-footer {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-top: 1px solid #333;
      }

      .chat-footer input {
        flex: 1;
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #333;
      }

      .chat-footer button {
        background-color: #ce2632;
        color: #e6e6e7;
        padding: 0.5rem;
        border-radius: 8px;
        cursor: pointer;
        border: none;
        margin-left: 0.5rem;
      }

      .chat-footer button:hover {
        background-color: #8b1d25;
      }

      .message {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 8px 8px 8px 0;
        background-color: #333;
        color: #e6e6e7;
        width: fit-content;
        max-width: 70%;
        box-shadow: 0px 4px 6px 0px rgba(0, 0, 0, 0.15);
      }

      .chat-body .message--mine {
        background-color: #ce2632;
        color: #e6e6e7;
        border-radius: 8px 8px 0 8px;
        margin: 1rem 0rem 1rem auto;
      }

      .message small {
        font-size: 0.75rem;
        font-weight: bold;
      }

      .message p {
        font-size: 1rem;
      }

      #boton-reservar:hover {
        background-color: #8b1d25;
      }
      /* MEDIA QUERIES */
      @media (max-width: 768px) {
        .menu-principal ul {
          flex-direction: column;
        }
        .item-menu {
          width: 100%;
        }
        footer {
          grid-template-columns: 1fr;
        }

        .info-pelicula-comprar {
          display: flex;
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .info-pelicula-comprar .detalles {
          gap: 0.5rem;
        }

        #container-seleccionar-sala {
          flex-direction: column;
          gap: 1rem;
          margin: 2rem 1rem;
        }

        .container-ver-asientos {
          margin: 0 1rem 2rem 1rem;
          padding: 1rem;
          overflow: scroll;
        }

        .container-leyenda-asientos {
          grid-template-columns: repeat(1, 1fr);
        }

        .container-asientos {
          display: grid;
          align-self: center;
          gap: 0.125rem;
          overflow: scroll;
          width: 100%;
          margin-bottom: 1rem;
        }

        .container-asientos div {
          color: white;
        }

        .fila-counter {
          text-align: center;
        }

        .ocupado {
          background-color: #ce2632;
          color: #ffffff;
          padding: 0.5rem;
          border-radius: 6px;
          cursor: pointer;
        }

        .resumen-compra {
          margin: 0 1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1 class="titleLogo">
        <a href="#"
          ><img
            class="titleLogoImg"
            src="../images/cinex-unidos.png"
            alt="Logo Cinex Unidos"
        /></a>
      </h1>
      <nav class="menu-principal">
        <ul>
          <li class="item-menu item-menu--actual">
            <a href="#">Inicio</a>
          </li>
          <li class="item-menu">
            <a href="#">Estrenos</a>
          </li>
          <li class="item-menu">
            <a href="#">Cines</a>
          </li>
          <li class="item-menu">
            <a href="#">Cartelera</a>
          </li>
          <li class="item-menu">
            <a href="#">Caramelería</a>
          </li>
          <li class="item-menu">
            <a href="#">Contacto</a>
          </li>
          <li class="item-menu">
            <a href="#">Mi cuenta</a>
          </li>
        </ul>
      </nav>
    </header>

    <main>
      <article id="vista-cartelera">
        <div class="container-titulo-cartelera">
          <h1 class="titulo-cartelera">Cartelera</h1>
          <select name="seleccionarCine" id="seleccionarCine"></select>
        </div>
        <hr />
        <section class="peliculas"></section>
      </article>
      <article class="vista-comprar-entrada">
        <section class="info-pelicula-comprar">
          <img src="" alt="" id="poster-pelicula" />
          <div class="detalles">
            <h1 id="nombre-pelicula"></h1>
            <p id="rating-duracion-pelicula"></p>
            <p id="descripcion-pelicula-comprar">
              Lorem ipsum dolor sit amet consectetur adipisicing elit.
              Repellendus est labore nostrum, inventore minima dolorum nulla qui
              a, beatae quibusdam, quo cum ad corporis hic sapiente molestias
              fugit enim omnis. Lorem ipsum dolor sit amet consectetur
              adipisicing elit. Vero enim laborum impedit! Reiciendis
              repudiandae animi voluptas molestiae vitae, possimus repellendus
              dignissimos esse dicta velit, blanditiis exercitationem illo
              veniam provident saepe.
            </p>
          </div>
          <!-- <p id="cineSeleccionado"></p> -->
        </section>

        <section class="comprar-entrada">
          <div id="container-seleccionar-sala"></div>
          <div class="container-ver-asientos">
            <div class="container-leyenda-asientos">
              <p class="leyenda-estatus-asiento ocupado">Ocupados</p>
              <p class="leyenda-estatus-asiento disponible">Disponibles</p>
              <p class="leyenda-estatus-asiento seleccionado">Seleccionados</p>
              <p class="leyenda-estatus-asiento seleccionado-otro">
                Seleccionados por otro usuario
              </p>
            </div>
            <div class="container-asientos"></div>
          </div>
        </section>
        <section class="resumen-compra">
          <h1>Asientos Seleccionados</h1>
          <div class="tickets"></div>
          <hr />
          <a id="boton-reservar">Reservar</a>
        </section>
      </article>
    </main>

    <footer>
      <div>
        <strong>Direcci&oacute;n principal</strong>
        <p>Cachicamo diciéndole a morrocoy <i>"conchuo"</i></p>
      </div>
      <div>
        <strong>Redes Sociales</strong>
        <nav>
          <a href=""><img src="./images/facebook.svg" alt="Facebook" /></a>
          <a href=""><img src="./images/x.svg" alt="X" /></a>
          <a href=""><img src="./images/instagram.svg" alt="Instagram" /></a>
        </nav>
      </div>
      <div>
        <strong>Contacto</strong>
        <address>
          <ul>
            <li><strong>Tel&eacute;fono: </strong>0212-55sin-corriente</li>
            <li><strong>Celular (Whatsapp): </strong>0424-555-5555</li>
            <li><strong>Fax: </strong>0212-555-5555</li>
          </ul>
        </address>
      </div>
    </footer>
    <div class="chat-button">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12 11H12.01M8 11H8.01M16 11H16.01M12.2896 17.9984C18.0965 17.9343 21 15.9189 21 11C21 6 18 4 12 4C6 4 3 6 3 11C3 14.0771 4.13623 16.018 6.40868 17.0557L5 21L12.2896 17.9984Z"
          stroke="black"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </div>
    <div class="chat">
      <form class="chat-header">
        <h1>Chat de soporte</h1>
        <button id="cerrar-chat">Cerrar</button>
      </form>
      <div class="chat-body"></div>
      <form class="chat-footer">
        <input type="text" id="mensaje" />
        <button id="enviar-mensaje">Enviar</button>
      </form>
    </div>
  </body>
  <script
    src="https://cdn.socket.io/4.7.5/socket.io.min.js"
    integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
    crossorigin="anonymous"
  ></script>

  <script type="module">
    import { generateName } from "./scripts/randomName.mjs";

    const BASE_URL = "https://cinexunidos-production.up.railway.app";

    let rawSeats = [];

    //GLOBALES
    let cineSeleccionado = "";

    //CARGAR CINES
    const cineSelect = document.getElementById("seleccionarCine");

    document.addEventListener("DOMContentLoaded", () => {
      cargarCines();
      cargarCartelera();
    });

    async function obtenerDatos(url) {
      const respuesta = await fetch(url);
      const datos = await respuesta.json();
      return datos;
    }

    const dataIds = {
      theatreId: cineSeleccionado,
      auditoriumId: "",
      showTimeId: "",
    };

    async function cargarCines() {
      const theatres = await obtenerDatos(`${BASE_URL}/theatres`);
      theatres.forEach((theatre) => {
        const option = document.createElement("option");
        option.value = theatre.id;
        option.textContent = theatre.name;
        cineSelect.appendChild(option);
      });
      cineSelect.value = "sambil-chacao";
    }

    async function cargarCartelera() {
      //Obtengo las salas del cine seleccionado
      cineSeleccionado = cineSelect.value;

      if (cineSelect.selectedIndex === -1) {
        cineSeleccionado = "sambil-chacao";
      }

      const salasCine = await obtenerDatos(
        `${BASE_URL}/theatres/${cineSeleccionado}/auditoriums`
      );

      //Referencio el contenedor de las peliculas
      const peliculasContainer = document.querySelector(".peliculas");
      peliculasContainer.innerHTML = "";

      let peliculas = []; //Peliculas solo disponibles en el cine seleccionado

      //Lleno el arreglo de peliculas solo con las que hay en ese cine
      salasCine.forEach((sala) => {
        sala.showtimes.forEach((show) => {
          const pelicula = show.movie;
          if (!peliculas.find((p) => p.id === pelicula.id)) {
            peliculas.push(pelicula);
          }
        });
      });

      peliculas.forEach((pelicula) => {
        const article = document.createElement("article");
        article.classList.add("pelicula");

        const img = document.createElement("img");
        img.src = `${BASE_URL}/${pelicula.poster}`;
        img.alt = `Poster de la película ${pelicula.name}`;
        article.appendChild(img);

        const descripcionPelicula = document.createElement("section");
        descripcionPelicula.classList.add("descripcion-pelicula");
        article.appendChild(descripcionPelicula);

        const h1 = document.createElement("h1");
        h1.textContent = pelicula.name;
        descripcionPelicula.appendChild(h1);

        const details = document.createElement("p");
        details.textContent = `${pelicula.rating} / ${pelicula.runningTime}`;
        descripcionPelicula.appendChild(details);

        const botonComprar = document.createElement("a");
        botonComprar.href = `#`;
        botonComprar.textContent = "Comprar";
        botonComprar.classList.add("boton-comprar-pelicula");
        botonComprar.addEventListener("click", () => {
          cambiarAVistaComprarEntrada(
            cineSeleccionado,
            cineSelect.textContent,
            pelicula
          );
        });
        descripcionPelicula.appendChild(botonComprar);

        peliculasContainer.appendChild(article);
      });
    }

    const vistaCartelera = document.getElementById("vista-cartelera");
    const vistaComprarEntrada = document.querySelector(
      ".vista-comprar-entrada"
    );
    function cambiarAVistaComprarEntrada(idCine, nombreCine, pelicula) {
      //La ponemos visible
      vistaCartelera.style.display = "none";
      vistaComprarEntrada.style.display = "block";

      //Cargamos los datos de la pelicula
      const posterPelicula = document.getElementById("poster-pelicula");
      posterPelicula.src = `${BASE_URL}/${pelicula.poster}`;

      const nombrePelicula = document.getElementById("nombre-pelicula");
      nombrePelicula.textContent = pelicula.name;

      const ratingDuracionPelicula = document.getElementById(
        "rating-duracion-pelicula"
      );
      ratingDuracionPelicula.textContent = `${pelicula.rating} / ${pelicula.runningTime}`;
      cargarHorasPelicula(idCine, pelicula.name);
      dataIds.theatreId = idCine;
    }

    //CARGAR CARTELERA UNA VEZ ELIGIO CINE
    cineSelect.addEventListener("change", async () => {
      cargarCartelera();
    });

    //CARGAR HORAS DE PELICULA
    async function cargarHorasPelicula(idCine, namePelicula) {
      const data = await fetch(`${BASE_URL}/theatres/${idCine}/auditoriums`);
      const salas = await data.json();

      salas.forEach((sala) => {
        sala.showtimes.forEach((show) => {
          if (show.movie.name === namePelicula) {
            const movieHourOption = document.createElement("a");
            movieHourOption.href = "";
            movieHourOption.textContent = show.startTime;
            movieHourOption.classList.add("movie-hour-option");

            //Escucha el evento click
            movieHourOption.addEventListener("click", (e) => {
              e.preventDefault();
              e.target.classList.add("movie-hour-option--selected");
              e.target.parentElement
                .querySelectorAll(".movie-hour-option")
                .forEach((option) => {
                  if (option !== e.target) {
                    option.classList.remove("movie-hour-option--selected");
                  }
                });
              dataIds.rawSeats = show.seats;
              dataIds.auditoriumId = sala.id;
              dataIds.showTimeId = show.id;
              cargarAsientos(sala.id, show.id);
              // actualizarAsientos(
              //   cineSeleccionado,
              //   sala.id,
              //   show.id,
              //   show.seats
              // );
            });
            document
              .querySelector("#container-seleccionar-sala")
              .appendChild(movieHourOption);
          }
        });
      });
    }

    let asientosSeleccionados = [];

    //CARGAR ASIENTOS
    async function cargarAsientos(idSala, idShow) {
      const containerAsientos = document.querySelector(".container-asientos");
      containerAsientos.innerHTML = "";

      let response = await fetch(
        `${BASE_URL}/theatres/${cineSeleccionado}/auditoriums/${idSala}/showtimes/${idShow}`
      );

      let datos = await response.json();

      let asientos = datos.seats;

      const entradas = Object.entries(asientos);
      //Dado que todas las filas tienen longitudes distintas, se calcula la de la mas larga
      const longitudFilaMasLarga = entradas.reduce((acc, entrada) => {
        if (entrada[1].length > acc) {
          return entrada[1].length;
        }
        return acc;
      }, 0);

      //Se crea la primera fila de numeros
      for (let i = 0; i < longitudFilaMasLarga; i++) {
        const div = document.createElement("div");
        if (i !== 0) {
          div.textContent = i;
          div.classList.add("fila-counter");
        } else {
          div.textContent = "";
        }
        containerAsientos.appendChild(div);
      }

      containerAsientos.style.gridTemplateColumns = `repeat(${longitudFilaMasLarga}, 25px)`;

      //Se ponen todos los arreglos de entradas de la misma longitud
      const entradasMismaLongitud = entradas.map((entrada) => {
        if (entrada[1].length < longitudFilaMasLarga) {
          const diferencia = longitudFilaMasLarga - entrada[1].length;
          const asientos = entrada[1];
          for (let i = 0; i < diferencia; i++) {
            asientos.push(-1);
          }
          return [entrada[0], asientos];
        }
        return entrada;
      });

      entradasMismaLongitud.forEach((entrada) => {
        const divFil = document.createElement("div");
        divFil.textContent = entrada[0];
        containerAsientos.appendChild(divFil);
        entrada[1].forEach((asiento, i) => {
          if (i === 0) {
            return;
          }
          const div = document.createElement("div");
          if (asiento === 0) {
            div.classList.add("disponible");
          } else if (asiento === 1) {
            div.classList.add("seleccionado-otro");
          } else if (asiento === -1) {
            div.classList.add("no-disponible");
          } else if (asiento === 2) {
            div.classList.add("ocupado");
          }

          div.addEventListener("click", () => {
            if (div.classList.contains("disponible")) {
              div.classList.remove("disponible");
              div.classList.add("seleccionado");
              asientosSeleccionados.push(`${entrada[0]}${i}`);
            } else if (div.classList.contains("seleccionado")) {
              div.classList.remove("seleccionado");
              div.classList.add("disponible");
              asientosSeleccionados;
            } else if (div.classList.contains("ocupado")) {
              div.classList.remove("ocupado");
              div.classList.add("disponible");
              gestionarAsiento(
                "eliminar",
                cineSeleccionado,
                idSala,
                idShow,
                `${entrada[0]}${i}`
              );
            }
          });
          containerAsientos.appendChild(div);
        });
      });
    }

    async function gestionarAsiento(
      accion,
      theatreId,
      auditoriumId,
      showTimeId,
      asiento
    ) {
      const URL = `${BASE_URL}/theatres/${theatreId}/auditoriums/${auditoriumId}/showtimes/${showTimeId}/reserve`;
      let options = {};
      if (accion === "reservar") {
        options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            seat: asiento,
          }),
        };
      } else if (accion === "eliminar") {
        options = {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            seat: asiento,
          }),
        };
      }
      const data = await fetch(URL, options);
    }

    async function actualizarAsientos(theatreId, auditoriumId, showTimeId) {
      const URL = `${BASE_URL}/theatres/${theatreId}/auditoriums/${auditoriumId}/showtimes/${showTimeId}/reservation-updates`;
      // const response = await fetch(URL);
      // const data = await response.json();
      const eventSource = new EventSource(URL);
      eventSource.onmessage = (e) => {
        cargarAsientos(auditoriumId, showTimeId);
      };
    }

    const botonReservar = document.getElementById("boton-reservar");
    botonReservar.addEventListener("click", (e) => {
      asientosSeleccionados.forEach((asiento) => {
        gestionarAsiento(
          "reservar",
          dataIds.theatreId,
          dataIds.auditoriumId,
          dataIds.showTimeId,
          asiento
        );
      });
      asientosSeleccionados = [];
      alert("Asientos reservados con éxito");
      cargarAsientos(dataIds.auditoriumId, dataIds.showTimeId);
      actualizarAsientos(
        dataIds.theatreId,
        dataIds.auditoriumId,
        dataIds.showTimeId
      );
    });

    // CHAT DE SOPORTE
    const $chatButton = document.querySelector(".chat-button");
    const $chat = document.querySelector(".chat");
    const $chatFooter = document.querySelector(".chat-footer");
    const $cerrarChat = document.querySelector("#cerrar-chat");
    const $enviarMensaje = document.querySelector("#enviar-mensaje");
    const $mensaje = document.querySelector("#mensaje");
    const $mensajes = document.querySelector(".chat-body");
    const chatUserName = generateName();

    const renderMessage = (payload) => {
      const { id, message, name } = payload;

      const $divElement = document.createElement("div");
      $divElement.classList.add("message");

      if (id === socket.id) {
        $divElement.classList.add("message--mine");
      }

      const small = document.createElement("small");
      small.textContent = name;

      const paragrapgh = document.createElement("p");
      paragrapgh.textContent = message;

      $divElement.appendChild(small);
      $divElement.appendChild(paragrapgh);

      $mensajes.appendChild($divElement);

      //Scrolleo al final
      $mensajes.scrollTop = $mensajes.scrollHeight;
    };

    $chatFooter.addEventListener("submit", (e) => {
      e.preventDefault();
      const message = $mensaje.value;
      if (message.trim().length === 0) {
        return;
      }

      socket.emit("send-message", message);

      $mensaje.value = "";
    });

    $chatButton.addEventListener("click", () => {
      $chat.style.display = "block";
      $chatButton.style.display = "none";

      socket.open();
    });

    $cerrarChat.addEventListener("click", (e) => {
      e.preventDefault();

      socket.close();
      $chat.style.display = "none";
      $chatButton.style.display = "block";
    });

    //SOCKET
    const socket = io(BASE_URL, {
      auth: {
        toker: "ABC-456",
        name: chatUserName,
      },
    });

    socket.on("connect", () => {
      console.log("Conectado ado");
    });

    socket.on("disconnect", () => {
      console.log("Desconectado ado");
    });

    socket.on("new-message", renderMessage);
  </script>
</html>
